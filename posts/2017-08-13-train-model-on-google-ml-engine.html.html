<!DOCTYPE html><html><head><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><link rel="apple-touch-icon" sizes="72x72" href="/android-icon-72x72.png"/><meta name="description" content="Kittinan"/><meta name="og:title" content="Kittinan"/><meta name="twitter:card" content="summary_large_image"/><link rel="stylesheet" data-href="https://fonts.googleapis.com/css2?family=Kanit:wght@100;200;400;700&amp;display=swap" data-optimized-fonts="true"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism-okaidia.min.css" integrity="sha512-mIs9kKbaw6JZFfSuo+MovjU+Ntggfoj8RwAmJbVXQ5mkAX5LlgETQEweFPI18humSPHymTb5iikEOKWF7I8ncQ==" crossorigin="anonymous" referrerpolicy="no-referrer"/><title>Train Model บน Cloud ด้วย Google Cloud Machine Learning Engine</title><meta name="next-head-count" content="10"/><link rel="preload" href="/_next/static/css/b2185e9d324f9be734ef.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b2185e9d324f9be734ef.css" data-n-g=""/><link rel="preload" href="/_next/static/css/bce56abbc99f2b43226b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/bce56abbc99f2b43226b.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a54b4f32bdc1ef890ddd.js"></script><script src="/_next/static/chunks/webpack-70ff542d2e22ae74aeb1.js" defer=""></script><script src="/_next/static/chunks/framework-b97a0ed4f13ff8397343.js" defer=""></script><script src="/_next/static/chunks/main-b4b241c8bbabbbce519d.js" defer=""></script><script src="/_next/static/chunks/pages/_app-7194f9233f9bbe08570a.js" defer=""></script><script src="/_next/static/chunks/503-1ff3c40465402917c38a.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-2cefdb2bc7590dd38e87.js" defer=""></script><script src="/_next/static/aI9pSBjpCZgVp7hfDsaNf/_buildManifest.js" defer=""></script><script src="/_next/static/aI9pSBjpCZgVp7hfDsaNf/_ssgManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=Kanit:wght@100;200;400;700&display=swap">@font-face{font-family:'Kanit';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/kanit/v7/nKKX-Go6G5tXcr72GwY.woff) format('woff')}@font-face{font-family:'Kanit';font-style:normal;font-weight:200;font-display:swap;src:url(https://fonts.gstatic.com/s/kanit/v7/nKKU-Go6G5tXcr5aOiWj.woff) format('woff')}@font-face{font-family:'Kanit';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/kanit/v7/nKKZ-Go6G5tXcoaR.woff) format('woff')}@font-face{font-family:'Kanit';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/kanit/v7/nKKU-Go6G5tXcr4uPiWj.woff) format('woff')}@font-face{font-family:'Kanit';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/kanit/v7/nKKX-Go6G5tXcr72KxaAcI5DPFpLGw.woff2) format('woff2');unicode-range:U+0E01-0E5B,U+200C-200D,U+25CC}@font-face{font-family:'Kanit';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/kanit/v7/nKKX-Go6G5tXcr72Kw2AcI5DPFpLGw.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Kanit';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/kanit/v7/nKKX-Go6G5tXcr72KwyAcI5DPFpLGw.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Kanit';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/kanit/v7/nKKX-Go6G5tXcr72KwKAcI5DPFo.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Kanit';font-style:normal;font-weight:200;font-display:swap;src:url(https://fonts.gstatic.com/s/kanit/v7/nKKU-Go6G5tXcr5aOhWzVaFrNlJzIu4.woff2) format('woff2');unicode-range:U+0E01-0E5B,U+200C-200D,U+25CC}@font-face{font-family:'Kanit';font-style:normal;font-weight:200;font-display:swap;src:url(https://fonts.gstatic.com/s/kanit/v7/nKKU-Go6G5tXcr5aOhWoVaFrNlJzIu4.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Kanit';font-style:normal;font-weight:200;font-display:swap;src:url(https://fonts.gstatic.com/s/kanit/v7/nKKU-Go6G5tXcr5aOhWpVaFrNlJzIu4.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Kanit';font-style:normal;font-weight:200;font-display:swap;src:url(https://fonts.gstatic.com/s/kanit/v7/nKKU-Go6G5tXcr5aOhWnVaFrNlJz.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Kanit';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/kanit/v7/nKKZ-Go6G5tXcraBGwCKd6xBDFs.woff2) format('woff2');unicode-range:U+0E01-0E5B,U+200C-200D,U+25CC}@font-face{font-family:'Kanit';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/kanit/v7/nKKZ-Go6G5tXcraaGwCKd6xBDFs.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Kanit';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/kanit/v7/nKKZ-Go6G5tXcrabGwCKd6xBDFs.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Kanit';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/kanit/v7/nKKZ-Go6G5tXcraVGwCKd6xB.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Kanit';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/kanit/v7/nKKU-Go6G5tXcr4uPhWzVaFrNlJzIu4.woff2) format('woff2');unicode-range:U+0E01-0E5B,U+200C-200D,U+25CC}@font-face{font-family:'Kanit';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/kanit/v7/nKKU-Go6G5tXcr4uPhWoVaFrNlJzIu4.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Kanit';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/kanit/v7/nKKU-Go6G5tXcr4uPhWpVaFrNlJzIu4.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Kanit';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/kanit/v7/nKKU-Go6G5tXcr4uPhWnVaFrNlJz.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next"><div><body><section class="ant-layout layout"><header class="ant-layout-header"><div class="logo"></div><ul class="ant-menu ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" role="button" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item ant-menu-item-only-child" role="menuitem"><span class="nav-text">Home</span></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" role="button" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item ant-menu-item-only-child" role="menuitem"><span class="nav-text">Blog</span></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute" role="menuitem"><div class="ant-menu-submenu-title" role="button" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul></header><main class="ant-layout-content"><div class="container"><main><article><h1 class="utils_headingXl__1XecN">Train Model บน Cloud ด้วย Google Cloud Machine Learning Engine</h1><div class="utils_lightText__12Ckm"><time dateTime="2017-08-13 12:06:00">August 13, 2017</time></div><div><p>สวัสดีครับผมจะมาเล่าประสบการณ์ การทดลองใช้งาน <a href="https://cloud.google.com/ml-engine/"><strong>Google Cloud Machine Learning Engine</strong></a> หรือเรียกสั้นๆ Cloud ML Engine โดยความสามารถของมันก็คือ การนำ Model Machine Learning ที่เราสร้างขึ้นมาโดย <a href="https://www.tensorflow.org/">Tensorflow</a> หรือ <a href="https://keras.io/">Keras</a> (Tensorflow Backend) ไป Train บน Cloud ของ Google นั่นเอง ซึ่งการใช้งาน Cloud ML Engine นั้นมีค่าใช้จ่ายคร่าวๆดังนี้  </p>
<p><a href="https://3.bp.blogspot.com/-ghbCz1e90j0/WYxMvtczNiI/AAAAAAAA0nE/TtV_h2HCgDMgmKxfPKb54Qsf8CwxIKr_wCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-10%2B19-08-14.png"><img src="https://3.bp.blogspot.com/-ghbCz1e90j0/WYxMvtczNiI/AAAAAAAA0nE/TtV_h2HCgDMgmKxfPKb54Qsf8CwxIKr_wCLcBGAs/s640/Screenshot%2Bat%2B2017-08-10%2B19-08-14.png"></a>  </p>
<p> วิธีการคำนวนราคาโดยละเอียดจะคิดเป็น ML training unit ซึ่งสามารถตรวจสอบได้ที่ <a href="https://cloud.google.com/ml-engine/pricing">https://cloud.google.com/ml-engine/pricing</a>  </p>
<p>สำหรับ Account Google Cloud ใหม่ Google จะให้ Credit 300 USD ใช้ได้ 12 เดือน ดูรายละเอียดได้ที่ <a href="https://cloud.google.com/free/">https://cloud.google.com/free/</a> (ผมก็ใช้ไอตัว Free Credit เนี่ยแหละมาลองเล่น)  </p>
<p> <strong>สิ่งที่ต้องการ</strong>  </p>
<ul>
<li>Account Google Cloud ที่ผูกบัตรเครดิตเรียบร้อย  </li>
<li>เครื่องที่ติดตั้ง  Google Cloud SDK เสร็จเรียบร้อย (วิธีการติดตั้งดูที่ <a href="https://cloud.google.com/sdk/downloads">https://cloud.google.com/sdk/downloads</a>)  </li>
<li>Code Model ที่ต้องการ Train (ในที่นี้ผมจะ Train โดยใช้ Keras ที่มี Tensorflow เป็น Backend โดยใช้โปรเจค <a href="https://github.com/kittinan/thai-handwriting-number">thai-handwriting-number</a>)  </li>
</ul>
<p><strong>สร้างโปรเจค</strong>  </p>
<ul>
<li>ทำการสร้างโปรเจคใหม่หรือจะใช้โปรเจคเดิมที่มีอยู่แล้วก็ได้  </li>
</ul>
<p>| <a href="https://1.bp.blogspot.com/-FgpPaZZVufs/WYxm9AYL72I/AAAAAAAA0nc/EWnvYtDOmcwk0AQgPBMIFUeJDpOsYedBACLcBGAs/s1600/Screenshot%2Bat%2B2017-08-10%2B20-59-16.png"><img src="https://1.bp.blogspot.com/-FgpPaZZVufs/WYxm9AYL72I/AAAAAAAA0nc/EWnvYtDOmcwk0AQgPBMIFUeJDpOsYedBACLcBGAs/s1600/Screenshot%2Bat%2B2017-08-10%2B20-59-16.png"></a> |
| สร้างโปรจคใหม่โดยใช้ชื่อ test-cloud-ml |</p>
<ul>
<li>รันคำสั่งในเครื่องเราเอง  </li>
</ul>
<blockquote>
<p>gcloud projects list</p>
</blockquote>
<p>ก็จะขึ้นโปรเจคใหม่ที่เราสร้างขึ้นมาดังภาพ  </p>
<p><a href="https://4.bp.blogspot.com/-odVVsQQqgn4/WYxo-Oit6wI/AAAAAAAA0no/GrMYC3X9auEZ-gxHO9wB5zy7ZhTEd53PACLcBGAs/s1600/Screenshot%2Bat%2B2017-08-10%2B21-06-31.png"><img src="https://4.bp.blogspot.com/-odVVsQQqgn4/WYxo-Oit6wI/AAAAAAAA0no/GrMYC3X9auEZ-gxHO9wB5zy7ZhTEd53PACLcBGAs/s640/Screenshot%2Bat%2B2017-08-10%2B21-06-31.png"></a>  </p>
<p>ตั้งให้โปรเจค test-cloud-ml เป็นโปรเจคหลัก (ใช้ PROJECT_ID)  </p>
<blockquote>
<p>gcloud config set project test-cloud-ml-176413</p>
</blockquote>
<p>เปิดการใช้งาน Google Cloud Machine Learning Engine ให้กับโปรเจคของเรา โดยเข้าไปที่ APIs &#x26; services > Library  </p>
<p>| <a href="https://2.bp.blogspot.com/-gdxbkOybfYs/WY5v1MwrSmI/AAAAAAAA0xU/McytEFTAXxQ76r_AHXVYoIeRzXgJ6UTJwCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-11%2B16-57-10.png"><img src="https://2.bp.blogspot.com/-gdxbkOybfYs/WY5v1MwrSmI/AAAAAAAA0xU/McytEFTAXxQ76r_AHXVYoIeRzXgJ6UTJwCLcBGAs/s640/Screenshot%2Bat%2B2017-08-11%2B16-57-10.png"></a> |
| เลือก Machine Learning Engine API |</p>
<p>| <a href="https://1.bp.blogspot.com/-fsOLbygwdHM/WY5v2L3o3II/AAAAAAAA0xY/5mFMAyEo6hc_ax36NXEdtpE5_R0DJ9THACLcBGAs/s1600/Screenshot%2Bat%2B2017-08-11%2B16-57-33.png"><img src="https://1.bp.blogspot.com/-fsOLbygwdHM/WY5v2L3o3II/AAAAAAAA0xY/5mFMAyEo6hc_ax36NXEdtpE5_R0DJ9THACLcBGAs/s640/Screenshot%2Bat%2B2017-08-11%2B16-57-33.png"></a> |
| กด Enable |</p>
<p> <strong>สิ่งที่ควรรู้ก่อนการปรับปรุง Code เพื่อนำไป Train บน Cloud</strong>  </p>
<ul>
<li> Cloud ML Runtime นั้นใช้ <strong>Python 2.7</strong> สามารถตรวจสอบ Package ต่างๆและ Version ของ Cloud ML Runtime ได้ที่ <a href="https://cloud.google.com/ml-engine/docs/concepts/runtime-version-list">https://cloud.google.com/ml-engine/docs/concepts/runtime-version-list</a>  </li>
<li>ข้อมูลที่เรา Read / Write ทั้งหมดนั้นต้องผ่าน <a href="https://cloud.google.com/storage/">Google Cloud Storage</a>  (เราควรจัดการ Dataset ที่จะใช้ Train ให้สะดวกในการใช้งาน ในที่นี้จะจัดการ Dataset ให้อยู่ใน format ของ pickle ซึ่งต้องใช้ protocol version 2)  </li>
</ul>
<p><strong>ปรับปรุง Code สำหรับ Train บน Cloud</strong>  </p>
<ol>
<li>จัดการอัพโหลด Dataset ที่ใช้ในการ Train อัพโหลดขึ้น Google Cloud Stroage เสียก่อน ในที่นี้ผม Serialize ข้อมูลด้วย pickle แล้วเซฟเป็นไฟล์ไว้ โดยต้องใช้ protolcol version 2  </li>
</ol>
<blockquote>
<p>pickle.dump(DATASET_VARIABLE, open("dataset.pkl", "wb"), protocol = 2)</p>
</blockquote>
<p>1.1 จัดการสร้าง bucket ของ Google Cloud Storage โดยในที่นี้จะตั้งชื่อ bucket ว่า kittinan (bucket เปรียบเสมือนตู้คอนเทนเนอร์อันนึงที่เอาไว้จัดเก็บข้อมูลของเรา <a href="https://cloud.google.com/storage/docs/key-terms#buckets">https://cloud.google.com/storage/docs/key-terms#buckets</a>)  โดยสร้าง bucket ด้วยคำสั่ง  </p>
<blockquote>
<p> gsutil mb gs://kittinan/</p>
</blockquote>
<p>หรือเราสามารถสร้างในหน้าเวปก็ได้  </p>
<p><a href="https://2.bp.blogspot.com/-UgXUlEF0-FU/WY2DVxwzdtI/AAAAAAAA0ro/N5KBPoE72PQt90zCocIWoTCQ3S2f6q-SwCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-11%2B17-13-26.png"><img src="https://2.bp.blogspot.com/-UgXUlEF0-FU/WY2DVxwzdtI/AAAAAAAA0ro/N5KBPoE72PQt90zCocIWoTCQ3S2f6q-SwCLcBGAs/s640/Screenshot%2Bat%2B2017-08-11%2B17-13-26.png"></a>  </p>
<p>1.2 อัพโหลดไฟล์ Dataset เข้า Google Cloud Storage ด้วยคำสั่ง  </p>
<blockquote>
<p>gsutil cp SOURCE gs:://BUCKET_NAME/</p>
</blockquote>
<p>ตัวอย่าง  </p>
<blockquote>
<p>gsutil cp src/thainumber_28.pkl gs://kittinan/</p>
</blockquote>
<p>| <a href="https://2.bp.blogspot.com/-7Tu4rpeiFGY/WY2FDucWZTI/AAAAAAAA0r4/cEvtg0UinS4o2wPlVRatLZdQ-8IGzxUgACLcBGAs/s1600/Screenshot%2Bat%2B2017-08-11%2B17-20-22.png"><img src="https://2.bp.blogspot.com/-7Tu4rpeiFGY/WY2FDucWZTI/AAAAAAAA0r4/cEvtg0UinS4o2wPlVRatLZdQ-8IGzxUgACLcBGAs/s640/Screenshot%2Bat%2B2017-08-11%2B17-20-22.png"></a> |
| ภาพเมื่ออัพโหลดไฟล์เสร็จ |</p>
<p>| <a href="https://3.bp.blogspot.com/-gmzoMc1GyN0/WY2FDulFAhI/AAAAAAAA0r0/3KPI8lUutvQmtOA46_DwUgXGOnQgnYGMwCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-11%2B17-20-50.png"><img src="https://3.bp.blogspot.com/-gmzoMc1GyN0/WY2FDulFAhI/AAAAAAAA0r0/3KPI8lUutvQmtOA46_DwUgXGOnQgnYGMwCLcBGAs/s640/Screenshot%2Bat%2B2017-08-11%2B17-20-50.png"></a> |
| ลองเข้าไปดูในหน้าเวป Google Cloud Storage ก็จะเจอไฟล์ที่เราเพิ่งอัพโหลดเพิ่มขึ้นมา |</p>
<ol start="2">
<li>สร้าง Folder ชื่ออะไรก็ได้ (ในที่นี้จะใช้ชื่อ Folder ว่า cloud-ml-engine) โดยมีโครงสร้างไฟล์ดังนี้  </li>
</ol>
<p><a href="https://3.bp.blogspot.com/-LPBb2YGLf-I/WY5-3yyqX5I/AAAAAAAA0x8/XgXFY8ZFvawtwiHagNzIckEjgnktBY50QCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B11-06-32.png"><img src="https://3.bp.blogspot.com/-LPBb2YGLf-I/WY5-3yyqX5I/AAAAAAAA0x8/XgXFY8ZFvawtwiHagNzIckEjgnktBY50QCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B11-06-32.png"></a>  </p>
<p><strong>setup.py</strong><br>
ระบุข้อมูลต่างๆ และ require package ต่างๆ<br>
<a href="https://cloud.google.com/ml-engine/docs/how-tos/packaging-trainer#recommended_project_structure">https://cloud.google.com/ml-engine/docs/how-tos/packaging-trainer#recommended_project_structure</a>  </p>
<p><strong>config.yml</strong><br>
ระบุค่า parameter ต่างๆของการ Train ครั้งนี้ ในที่นี้ระบุว่าให้ใช้ scaleTiear ที่เป็น BASIC_GPU<br>
<a href="https://cloud.google.com/ml-engine/reference/rest/v1/projects.jobs#traininginput">https://cloud.google.com/ml-engine/reference/rest/v1/projects.jobs#traininginput</a>  </p>
<p> <strong>trainer > __init__.py</strong><br>
ไฟล์เปล่าๆ ใช้สำหรับ setuptools ที่อยู่ในไฟล์ setup.py   </p>
<p><strong>trainer > model.py</strong>  </p>
<ul>
<li>ใช้ argparse module ในการ parse argument ต่างๆ โดยใน code นี้จะทำการ parse argument ของ training data และ job directory (Google Cloud Storage Path)  </li>
<li>Read / Write File ต่างๆ ด้วย tensorflow.python.lib.io.file_io แทน  </li>
</ul>
<p><strong>ทดสอบรันบนเครื่องตัวเองก่อนด้วยคำสั่ง</strong>  </p>
<blockquote>
<p>gcloud ml-engine local train \<br>
--job-dir ./ \<br>
--module-name trainer.model \<br>
--package-path ./trainer \<br>
-- \<br>
--train-file ../thainumber_28.pkl</p>
</blockquote>
<p>--job-dir : directory หรือ Google Cloud Storage ที่ใช้ในการ Package ไฟล์ (ML Engine จะส่ง argument job-dir ไปยัง script โปรแกรมเราด้วย)<br>
--module-name : module ที่เราต้องการรัน<br>
--package-path : path ของ module ที่เราจะรัน<br>
option ที่อยู่หลัง -- \ : คือ argument สำหรับ script โปรแกรมเรา  </p>
<p>| <a href="https://2.bp.blogspot.com/-hZOegOna7tY/WY6I58YA4rI/AAAAAAAA0yM/krZFp04WJMECu8iyQX2o-v93ciabKQ_pgCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B11-49-31.png"><img src="https://2.bp.blogspot.com/-hZOegOna7tY/WY6I58YA4rI/AAAAAAAA0yM/krZFp04WJMECu8iyQX2o-v93ciabKQ_pgCLcBGAs/s640/Screenshot%2Bat%2B2017-08-12%2B11-49-31.png"></a> |
| ภาพการรันบนเครื่องตัวเอง |</p>
<p><strong>รันบน Cloud ML Engine</strong><br>
ผมสร้าง Shell Script ขึ้นมาชื่อไฟล์ start_train.sh เพื่อความสะดวกในการแก้ไขค่าต่างๆและการรัน โดยมีคำสั่งดังนี้  </p>
<p>export environment variables ต่างๆดังนี้<br>
BUCKET_NAME - ชื่อ Bucket Google Cloud Storage ที่เราใช้<br>
JOB_NAME - ชื่อ job ของเรา<br>
JOB_DIR - Path Bucket Google Cloud Storage<br>
REGION - จะใช้ region ไหนในการรัน (ในที่นี้ใช้ US เพราะถูกกว่า)  </p>
<p>Option ต่างๆของ command gcloud ก็จะคล้ายๆกับการรันแบบ Local โดยที่มีเพิ่มเติมขึ้นมาดังนี้  </p>
<p>--runtime-version : จะใช้ runtime version ไหน (<a href="https://cloud.google.com/ml-engine/docs/concepts/runtime-version-list">https://cloud.google.com/ml-engine/docs/concepts/runtime-version-list</a>)<br>
--region : จะใช้ region ไหน<br>
--config : config yaml ไฟล์ ที่ระบุ training input ต่างๆ<br>
--train-file : Argument ของ script ที่ระบุ Path Training Data ที่อยู่บน  Google Cloud Storage  </p>
<p>ลองรัน ./start_train.sh กันเลย  </p>
<p><a href="https://1.bp.blogspot.com/-8gFd_NQ1V-E/WY6ONROzTQI/AAAAAAAA0yc/g0WJqCSOFzsBoUCZe3EatIFZzte-tGo9gCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B12-02-24.png"><img src="https://1.bp.blogspot.com/-8gFd_NQ1V-E/WY6ONROzTQI/AAAAAAAA0yc/g0WJqCSOFzsBoUCZe3EatIFZzte-tGo9gCLcBGAs/s640/Screenshot%2Bat%2B2017-08-12%2B12-02-24.png"></a>  </p>
<p>เมื่อเรารันสำเร็จ gcloud command จะแนะนำคำสั่งในการ stream log ให้เรา เมื่อลองรันดูก็จะเห็น log ในการรันบน cloud ต่างๆดังภาพ  </p>
<p><a href="https://1.bp.blogspot.com/-yBpj9m2XGWs/WY6Ojco-ezI/AAAAAAAA0yg/PvgbCyjCyQMZ0pB5w7LZGkyMP-g5m5MNQCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B12-02-42.png"><img src="https://1.bp.blogspot.com/-yBpj9m2XGWs/WY6Ojco-ezI/AAAAAAAA0yg/PvgbCyjCyQMZ0pB5w7LZGkyMP-g5m5MNQCLcBGAs/s640/Screenshot%2Bat%2B2017-08-12%2B12-02-42.png"></a><br>
เราสามารถเข้าไปดู Log ในเวปได้ด้วยนะ<br>
<a href="https://console.cloud.google.com/mlengine/jobs">https://console.cloud.google.com/mlengine/jobs</a>  </p>
<p><a href="https://4.bp.blogspot.com/-rOul_7niNUY/WY6PJYyQiHI/AAAAAAAA0ys/ljfdi0GcZ0MTnbQnEVHfrotyfvRCi8LyACLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B12-15-19.png"><img src="https://4.bp.blogspot.com/-rOul_7niNUY/WY6PJYyQiHI/AAAAAAAA0ys/ljfdi0GcZ0MTnbQnEVHfrotyfvRCi8LyACLcBGAs/s400/Screenshot%2Bat%2B2017-08-12%2B12-15-19.png"></a>  </p>
<p><a href="https://2.bp.blogspot.com/-SDXafD-P9kE/WY6PJeaq95I/AAAAAAAA0yo/2WeEmJsBkp4uXpTSxB6bHB7zIYcMUUF3gCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B12-15-58.png"><img src="https://2.bp.blogspot.com/-SDXafD-P9kE/WY6PJeaq95I/AAAAAAAA0yo/2WeEmJsBkp4uXpTSxB6bHB7zIYcMUUF3gCLcBGAs/s400/Screenshot%2Bat%2B2017-08-12%2B12-15-58.png"></a><br>
หลังจากรันเสร็จลองเข้าไปดูใน  Bucket ของเราก็จะพบกับ folder ที่มีชื่อ job name ของเรา  </p>
<p><a href="https://1.bp.blogspot.com/-L6akpOsvIH8/WY6PkkVaxvI/AAAAAAAA0yw/Ur6HRg3fPWQVvgF2BucUivsDAUnduZw3ACLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B12-17-52.png"><img src="https://1.bp.blogspot.com/-L6akpOsvIH8/WY6PkkVaxvI/AAAAAAAA0yw/Ur6HRg3fPWQVvgF2BucUivsDAUnduZw3ACLcBGAs/s640/Screenshot%2Bat%2B2017-08-12%2B12-17-52.png"></a><br>
เมื่อเข้าไปใน folder ก็จะพบ model_weight.h5 ที่เราสั่งเซฟไว้ใน Code ของเราหลัง Train เสร็จ  </p>
<p>เป็นอันเสร็จสิ้นการทดลองเล่น Google Cloud Machine Learning Engine ครับผม  </p>
<p><strong>เพิ่มเติม</strong>  </p>
<p>ทดลอง Download weight model มาลองรัน predict ดู  </p>
<p><a href="https://2.bp.blogspot.com/-KZphJ4YP2IQ/WY6TO9Z-WOI/AAAAAAAA0y8/acz9X9uXQT4aMuYRbZjDNV0LKMn5PGINACLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B12-33-12.png"><img src="https://2.bp.blogspot.com/-KZphJ4YP2IQ/WY6TO9Z-WOI/AAAAAAAA0y8/acz9X9uXQT4aMuYRbZjDNV0LKMn5PGINACLcBGAs/s640/Screenshot%2Bat%2B2017-08-12%2B12-33-12.png"></a><br>
<strong>สามารถดู Code ทั้งหมดได้ที่</strong><br>
<a href="https://github.com/kittinan/thai-handwriting-number">https://github.com/kittinan/thai-handwriting-number</a><br>
<a href="https://github.com/kittinan/thai-handwriting-number/tree/master/src/cloud-ml-engine">https://github.com/kittinan/thai-handwriting-number/tree/master/src/cloud-ml-engine</a>  </p>
<p><strong>อ้างอิง</strong><br>
<a href="https://cloud.google.com/ml-engine">https://cloud.google.com/ml-engine</a><br>
<a href="https://github.com/clintonreece/keras-cloud-ml-engine">https://github.com/clintonreece/keras-cloud-ml-engine</a></p>
</div></article></main></div></main><footer class="ant-layout-footer" style="text-align:center">Kittinan ©2021</footer></section></body></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"2017-08-13-train-model-on-google-ml-engine.html","contentHtml":"\u003cp\u003eสวัสดีครับผมจะมาเล่าประสบการณ์ การทดลองใช้งาน \u003ca href=\"https://cloud.google.com/ml-engine/\"\u003e\u003cstrong\u003eGoogle Cloud Machine Learning Engine\u003c/strong\u003e\u003c/a\u003e หรือเรียกสั้นๆ Cloud ML Engine โดยความสามารถของมันก็คือ การนำ Model Machine Learning ที่เราสร้างขึ้นมาโดย \u003ca href=\"https://www.tensorflow.org/\"\u003eTensorflow\u003c/a\u003e หรือ \u003ca href=\"https://keras.io/\"\u003eKeras\u003c/a\u003e (Tensorflow Backend) ไป Train บน Cloud ของ Google นั่นเอง ซึ่งการใช้งาน Cloud ML Engine นั้นมีค่าใช้จ่ายคร่าวๆดังนี้  \u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://3.bp.blogspot.com/-ghbCz1e90j0/WYxMvtczNiI/AAAAAAAA0nE/TtV_h2HCgDMgmKxfPKb54Qsf8CwxIKr_wCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-10%2B19-08-14.png\"\u003e\u003cimg src=\"https://3.bp.blogspot.com/-ghbCz1e90j0/WYxMvtczNiI/AAAAAAAA0nE/TtV_h2HCgDMgmKxfPKb54Qsf8CwxIKr_wCLcBGAs/s640/Screenshot%2Bat%2B2017-08-10%2B19-08-14.png\"\u003e\u003c/a\u003e  \u003c/p\u003e\n\u003cp\u003e วิธีการคำนวนราคาโดยละเอียดจะคิดเป็น ML training unit ซึ่งสามารถตรวจสอบได้ที่ \u003ca href=\"https://cloud.google.com/ml-engine/pricing\"\u003ehttps://cloud.google.com/ml-engine/pricing\u003c/a\u003e  \u003c/p\u003e\n\u003cp\u003eสำหรับ Account Google Cloud ใหม่ Google จะให้ Credit 300 USD ใช้ได้ 12 เดือน ดูรายละเอียดได้ที่ \u003ca href=\"https://cloud.google.com/free/\"\u003ehttps://cloud.google.com/free/\u003c/a\u003e (ผมก็ใช้ไอตัว Free Credit เนี่ยแหละมาลองเล่น)  \u003c/p\u003e\n\u003cp\u003e \u003cstrong\u003eสิ่งที่ต้องการ\u003c/strong\u003e  \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAccount Google Cloud ที่ผูกบัตรเครดิตเรียบร้อย  \u003c/li\u003e\n\u003cli\u003eเครื่องที่ติดตั้ง  Google Cloud SDK เสร็จเรียบร้อย (วิธีการติดตั้งดูที่ \u003ca href=\"https://cloud.google.com/sdk/downloads\"\u003ehttps://cloud.google.com/sdk/downloads\u003c/a\u003e)  \u003c/li\u003e\n\u003cli\u003eCode Model ที่ต้องการ Train (ในที่นี้ผมจะ Train โดยใช้ Keras ที่มี Tensorflow เป็น Backend โดยใช้โปรเจค \u003ca href=\"https://github.com/kittinan/thai-handwriting-number\"\u003ethai-handwriting-number\u003c/a\u003e)  \u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eสร้างโปรเจค\u003c/strong\u003e  \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eทำการสร้างโปรเจคใหม่หรือจะใช้โปรเจคเดิมที่มีอยู่แล้วก็ได้  \u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e| \u003ca href=\"https://1.bp.blogspot.com/-FgpPaZZVufs/WYxm9AYL72I/AAAAAAAA0nc/EWnvYtDOmcwk0AQgPBMIFUeJDpOsYedBACLcBGAs/s1600/Screenshot%2Bat%2B2017-08-10%2B20-59-16.png\"\u003e\u003cimg src=\"https://1.bp.blogspot.com/-FgpPaZZVufs/WYxm9AYL72I/AAAAAAAA0nc/EWnvYtDOmcwk0AQgPBMIFUeJDpOsYedBACLcBGAs/s1600/Screenshot%2Bat%2B2017-08-10%2B20-59-16.png\"\u003e\u003c/a\u003e |\n| สร้างโปรจคใหม่โดยใช้ชื่อ test-cloud-ml |\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eรันคำสั่งในเครื่องเราเอง  \u003c/li\u003e\n\u003c/ul\u003e\n\u003cblockquote\u003e\n\u003cp\u003egcloud projects list\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eก็จะขึ้นโปรเจคใหม่ที่เราสร้างขึ้นมาดังภาพ  \u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://4.bp.blogspot.com/-odVVsQQqgn4/WYxo-Oit6wI/AAAAAAAA0no/GrMYC3X9auEZ-gxHO9wB5zy7ZhTEd53PACLcBGAs/s1600/Screenshot%2Bat%2B2017-08-10%2B21-06-31.png\"\u003e\u003cimg src=\"https://4.bp.blogspot.com/-odVVsQQqgn4/WYxo-Oit6wI/AAAAAAAA0no/GrMYC3X9auEZ-gxHO9wB5zy7ZhTEd53PACLcBGAs/s640/Screenshot%2Bat%2B2017-08-10%2B21-06-31.png\"\u003e\u003c/a\u003e  \u003c/p\u003e\n\u003cp\u003eตั้งให้โปรเจค test-cloud-ml เป็นโปรเจคหลัก (ใช้ PROJECT_ID)  \u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003egcloud config set project test-cloud-ml-176413\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eเปิดการใช้งาน Google Cloud Machine Learning Engine ให้กับโปรเจคของเรา โดยเข้าไปที่ APIs \u0026#x26; services \u003e Library  \u003c/p\u003e\n\u003cp\u003e| \u003ca href=\"https://2.bp.blogspot.com/-gdxbkOybfYs/WY5v1MwrSmI/AAAAAAAA0xU/McytEFTAXxQ76r_AHXVYoIeRzXgJ6UTJwCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-11%2B16-57-10.png\"\u003e\u003cimg src=\"https://2.bp.blogspot.com/-gdxbkOybfYs/WY5v1MwrSmI/AAAAAAAA0xU/McytEFTAXxQ76r_AHXVYoIeRzXgJ6UTJwCLcBGAs/s640/Screenshot%2Bat%2B2017-08-11%2B16-57-10.png\"\u003e\u003c/a\u003e |\n| เลือก Machine Learning Engine API |\u003c/p\u003e\n\u003cp\u003e| \u003ca href=\"https://1.bp.blogspot.com/-fsOLbygwdHM/WY5v2L3o3II/AAAAAAAA0xY/5mFMAyEo6hc_ax36NXEdtpE5_R0DJ9THACLcBGAs/s1600/Screenshot%2Bat%2B2017-08-11%2B16-57-33.png\"\u003e\u003cimg src=\"https://1.bp.blogspot.com/-fsOLbygwdHM/WY5v2L3o3II/AAAAAAAA0xY/5mFMAyEo6hc_ax36NXEdtpE5_R0DJ9THACLcBGAs/s640/Screenshot%2Bat%2B2017-08-11%2B16-57-33.png\"\u003e\u003c/a\u003e |\n| กด Enable |\u003c/p\u003e\n\u003cp\u003e \u003cstrong\u003eสิ่งที่ควรรู้ก่อนการปรับปรุง Code เพื่อนำไป Train บน Cloud\u003c/strong\u003e  \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e Cloud ML Runtime นั้นใช้ \u003cstrong\u003ePython 2.7\u003c/strong\u003e สามารถตรวจสอบ Package ต่างๆและ Version ของ Cloud ML Runtime ได้ที่ \u003ca href=\"https://cloud.google.com/ml-engine/docs/concepts/runtime-version-list\"\u003ehttps://cloud.google.com/ml-engine/docs/concepts/runtime-version-list\u003c/a\u003e  \u003c/li\u003e\n\u003cli\u003eข้อมูลที่เรา Read / Write ทั้งหมดนั้นต้องผ่าน \u003ca href=\"https://cloud.google.com/storage/\"\u003eGoogle Cloud Storage\u003c/a\u003e  (เราควรจัดการ Dataset ที่จะใช้ Train ให้สะดวกในการใช้งาน ในที่นี้จะจัดการ Dataset ให้อยู่ใน format ของ pickle ซึ่งต้องใช้ protocol version 2)  \u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eปรับปรุง Code สำหรับ Train บน Cloud\u003c/strong\u003e  \u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eจัดการอัพโหลด Dataset ที่ใช้ในการ Train อัพโหลดขึ้น Google Cloud Stroage เสียก่อน ในที่นี้ผม Serialize ข้อมูลด้วย pickle แล้วเซฟเป็นไฟล์ไว้ โดยต้องใช้ protolcol version 2  \u003c/li\u003e\n\u003c/ol\u003e\n\u003cblockquote\u003e\n\u003cp\u003epickle.dump(DATASET_VARIABLE, open(\"dataset.pkl\", \"wb\"), protocol = 2)\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e1.1 จัดการสร้าง bucket ของ Google Cloud Storage โดยในที่นี้จะตั้งชื่อ bucket ว่า kittinan (bucket เปรียบเสมือนตู้คอนเทนเนอร์อันนึงที่เอาไว้จัดเก็บข้อมูลของเรา \u003ca href=\"https://cloud.google.com/storage/docs/key-terms#buckets\"\u003ehttps://cloud.google.com/storage/docs/key-terms#buckets\u003c/a\u003e)  โดยสร้าง bucket ด้วยคำสั่ง  \u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e gsutil mb gs://kittinan/\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eหรือเราสามารถสร้างในหน้าเวปก็ได้  \u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://2.bp.blogspot.com/-UgXUlEF0-FU/WY2DVxwzdtI/AAAAAAAA0ro/N5KBPoE72PQt90zCocIWoTCQ3S2f6q-SwCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-11%2B17-13-26.png\"\u003e\u003cimg src=\"https://2.bp.blogspot.com/-UgXUlEF0-FU/WY2DVxwzdtI/AAAAAAAA0ro/N5KBPoE72PQt90zCocIWoTCQ3S2f6q-SwCLcBGAs/s640/Screenshot%2Bat%2B2017-08-11%2B17-13-26.png\"\u003e\u003c/a\u003e  \u003c/p\u003e\n\u003cp\u003e1.2 อัพโหลดไฟล์ Dataset เข้า Google Cloud Storage ด้วยคำสั่ง  \u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003egsutil cp SOURCE gs:://BUCKET_NAME/\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eตัวอย่าง  \u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003egsutil cp src/thainumber_28.pkl gs://kittinan/\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e| \u003ca href=\"https://2.bp.blogspot.com/-7Tu4rpeiFGY/WY2FDucWZTI/AAAAAAAA0r4/cEvtg0UinS4o2wPlVRatLZdQ-8IGzxUgACLcBGAs/s1600/Screenshot%2Bat%2B2017-08-11%2B17-20-22.png\"\u003e\u003cimg src=\"https://2.bp.blogspot.com/-7Tu4rpeiFGY/WY2FDucWZTI/AAAAAAAA0r4/cEvtg0UinS4o2wPlVRatLZdQ-8IGzxUgACLcBGAs/s640/Screenshot%2Bat%2B2017-08-11%2B17-20-22.png\"\u003e\u003c/a\u003e |\n| ภาพเมื่ออัพโหลดไฟล์เสร็จ |\u003c/p\u003e\n\u003cp\u003e| \u003ca href=\"https://3.bp.blogspot.com/-gmzoMc1GyN0/WY2FDulFAhI/AAAAAAAA0r0/3KPI8lUutvQmtOA46_DwUgXGOnQgnYGMwCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-11%2B17-20-50.png\"\u003e\u003cimg src=\"https://3.bp.blogspot.com/-gmzoMc1GyN0/WY2FDulFAhI/AAAAAAAA0r0/3KPI8lUutvQmtOA46_DwUgXGOnQgnYGMwCLcBGAs/s640/Screenshot%2Bat%2B2017-08-11%2B17-20-50.png\"\u003e\u003c/a\u003e |\n| ลองเข้าไปดูในหน้าเวป Google Cloud Storage ก็จะเจอไฟล์ที่เราเพิ่งอัพโหลดเพิ่มขึ้นมา |\u003c/p\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003eสร้าง Folder ชื่ออะไรก็ได้ (ในที่นี้จะใช้ชื่อ Folder ว่า cloud-ml-engine) โดยมีโครงสร้างไฟล์ดังนี้  \u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003ca href=\"https://3.bp.blogspot.com/-LPBb2YGLf-I/WY5-3yyqX5I/AAAAAAAA0x8/XgXFY8ZFvawtwiHagNzIckEjgnktBY50QCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B11-06-32.png\"\u003e\u003cimg src=\"https://3.bp.blogspot.com/-LPBb2YGLf-I/WY5-3yyqX5I/AAAAAAAA0x8/XgXFY8ZFvawtwiHagNzIckEjgnktBY50QCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B11-06-32.png\"\u003e\u003c/a\u003e  \u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003esetup.py\u003c/strong\u003e\u003cbr\u003e\nระบุข้อมูลต่างๆ และ require package ต่างๆ\u003cbr\u003e\n\u003ca href=\"https://cloud.google.com/ml-engine/docs/how-tos/packaging-trainer#recommended_project_structure\"\u003ehttps://cloud.google.com/ml-engine/docs/how-tos/packaging-trainer#recommended_project_structure\u003c/a\u003e  \u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003econfig.yml\u003c/strong\u003e\u003cbr\u003e\nระบุค่า parameter ต่างๆของการ Train ครั้งนี้ ในที่นี้ระบุว่าให้ใช้ scaleTiear ที่เป็น BASIC_GPU\u003cbr\u003e\n\u003ca href=\"https://cloud.google.com/ml-engine/reference/rest/v1/projects.jobs#traininginput\"\u003ehttps://cloud.google.com/ml-engine/reference/rest/v1/projects.jobs#traininginput\u003c/a\u003e  \u003c/p\u003e\n\u003cp\u003e \u003cstrong\u003etrainer \u003e __init__.py\u003c/strong\u003e\u003cbr\u003e\nไฟล์เปล่าๆ ใช้สำหรับ setuptools ที่อยู่ในไฟล์ setup.py   \u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003etrainer \u003e model.py\u003c/strong\u003e  \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eใช้ argparse module ในการ parse argument ต่างๆ โดยใน code นี้จะทำการ parse argument ของ training data และ job directory (Google Cloud Storage Path)  \u003c/li\u003e\n\u003cli\u003eRead / Write File ต่างๆ ด้วย tensorflow.python.lib.io.file_io แทน  \u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eทดสอบรันบนเครื่องตัวเองก่อนด้วยคำสั่ง\u003c/strong\u003e  \u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003egcloud ml-engine local train \\\u003cbr\u003e\n--job-dir ./ \\\u003cbr\u003e\n--module-name trainer.model \\\u003cbr\u003e\n--package-path ./trainer \\\u003cbr\u003e\n-- \\\u003cbr\u003e\n--train-file ../thainumber_28.pkl\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e--job-dir : directory หรือ Google Cloud Storage ที่ใช้ในการ Package ไฟล์ (ML Engine จะส่ง argument job-dir ไปยัง script โปรแกรมเราด้วย)\u003cbr\u003e\n--module-name : module ที่เราต้องการรัน\u003cbr\u003e\n--package-path : path ของ module ที่เราจะรัน\u003cbr\u003e\noption ที่อยู่หลัง -- \\ : คือ argument สำหรับ script โปรแกรมเรา  \u003c/p\u003e\n\u003cp\u003e| \u003ca href=\"https://2.bp.blogspot.com/-hZOegOna7tY/WY6I58YA4rI/AAAAAAAA0yM/krZFp04WJMECu8iyQX2o-v93ciabKQ_pgCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B11-49-31.png\"\u003e\u003cimg src=\"https://2.bp.blogspot.com/-hZOegOna7tY/WY6I58YA4rI/AAAAAAAA0yM/krZFp04WJMECu8iyQX2o-v93ciabKQ_pgCLcBGAs/s640/Screenshot%2Bat%2B2017-08-12%2B11-49-31.png\"\u003e\u003c/a\u003e |\n| ภาพการรันบนเครื่องตัวเอง |\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eรันบน Cloud ML Engine\u003c/strong\u003e\u003cbr\u003e\nผมสร้าง Shell Script ขึ้นมาชื่อไฟล์ start_train.sh เพื่อความสะดวกในการแก้ไขค่าต่างๆและการรัน โดยมีคำสั่งดังนี้  \u003c/p\u003e\n\u003cp\u003eexport environment variables ต่างๆดังนี้\u003cbr\u003e\nBUCKET_NAME - ชื่อ Bucket Google Cloud Storage ที่เราใช้\u003cbr\u003e\nJOB_NAME - ชื่อ job ของเรา\u003cbr\u003e\nJOB_DIR - Path Bucket Google Cloud Storage\u003cbr\u003e\nREGION - จะใช้ region ไหนในการรัน (ในที่นี้ใช้ US เพราะถูกกว่า)  \u003c/p\u003e\n\u003cp\u003eOption ต่างๆของ command gcloud ก็จะคล้ายๆกับการรันแบบ Local โดยที่มีเพิ่มเติมขึ้นมาดังนี้  \u003c/p\u003e\n\u003cp\u003e--runtime-version : จะใช้ runtime version ไหน (\u003ca href=\"https://cloud.google.com/ml-engine/docs/concepts/runtime-version-list\"\u003ehttps://cloud.google.com/ml-engine/docs/concepts/runtime-version-list\u003c/a\u003e)\u003cbr\u003e\n--region : จะใช้ region ไหน\u003cbr\u003e\n--config : config yaml ไฟล์ ที่ระบุ training input ต่างๆ\u003cbr\u003e\n--train-file : Argument ของ script ที่ระบุ Path Training Data ที่อยู่บน  Google Cloud Storage  \u003c/p\u003e\n\u003cp\u003eลองรัน ./start_train.sh กันเลย  \u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://1.bp.blogspot.com/-8gFd_NQ1V-E/WY6ONROzTQI/AAAAAAAA0yc/g0WJqCSOFzsBoUCZe3EatIFZzte-tGo9gCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B12-02-24.png\"\u003e\u003cimg src=\"https://1.bp.blogspot.com/-8gFd_NQ1V-E/WY6ONROzTQI/AAAAAAAA0yc/g0WJqCSOFzsBoUCZe3EatIFZzte-tGo9gCLcBGAs/s640/Screenshot%2Bat%2B2017-08-12%2B12-02-24.png\"\u003e\u003c/a\u003e  \u003c/p\u003e\n\u003cp\u003eเมื่อเรารันสำเร็จ gcloud command จะแนะนำคำสั่งในการ stream log ให้เรา เมื่อลองรันดูก็จะเห็น log ในการรันบน cloud ต่างๆดังภาพ  \u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://1.bp.blogspot.com/-yBpj9m2XGWs/WY6Ojco-ezI/AAAAAAAA0yg/PvgbCyjCyQMZ0pB5w7LZGkyMP-g5m5MNQCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B12-02-42.png\"\u003e\u003cimg src=\"https://1.bp.blogspot.com/-yBpj9m2XGWs/WY6Ojco-ezI/AAAAAAAA0yg/PvgbCyjCyQMZ0pB5w7LZGkyMP-g5m5MNQCLcBGAs/s640/Screenshot%2Bat%2B2017-08-12%2B12-02-42.png\"\u003e\u003c/a\u003e\u003cbr\u003e\nเราสามารถเข้าไปดู Log ในเวปได้ด้วยนะ\u003cbr\u003e\n\u003ca href=\"https://console.cloud.google.com/mlengine/jobs\"\u003ehttps://console.cloud.google.com/mlengine/jobs\u003c/a\u003e  \u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://4.bp.blogspot.com/-rOul_7niNUY/WY6PJYyQiHI/AAAAAAAA0ys/ljfdi0GcZ0MTnbQnEVHfrotyfvRCi8LyACLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B12-15-19.png\"\u003e\u003cimg src=\"https://4.bp.blogspot.com/-rOul_7niNUY/WY6PJYyQiHI/AAAAAAAA0ys/ljfdi0GcZ0MTnbQnEVHfrotyfvRCi8LyACLcBGAs/s400/Screenshot%2Bat%2B2017-08-12%2B12-15-19.png\"\u003e\u003c/a\u003e  \u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://2.bp.blogspot.com/-SDXafD-P9kE/WY6PJeaq95I/AAAAAAAA0yo/2WeEmJsBkp4uXpTSxB6bHB7zIYcMUUF3gCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B12-15-58.png\"\u003e\u003cimg src=\"https://2.bp.blogspot.com/-SDXafD-P9kE/WY6PJeaq95I/AAAAAAAA0yo/2WeEmJsBkp4uXpTSxB6bHB7zIYcMUUF3gCLcBGAs/s400/Screenshot%2Bat%2B2017-08-12%2B12-15-58.png\"\u003e\u003c/a\u003e\u003cbr\u003e\nหลังจากรันเสร็จลองเข้าไปดูใน  Bucket ของเราก็จะพบกับ folder ที่มีชื่อ job name ของเรา  \u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://1.bp.blogspot.com/-L6akpOsvIH8/WY6PkkVaxvI/AAAAAAAA0yw/Ur6HRg3fPWQVvgF2BucUivsDAUnduZw3ACLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B12-17-52.png\"\u003e\u003cimg src=\"https://1.bp.blogspot.com/-L6akpOsvIH8/WY6PkkVaxvI/AAAAAAAA0yw/Ur6HRg3fPWQVvgF2BucUivsDAUnduZw3ACLcBGAs/s640/Screenshot%2Bat%2B2017-08-12%2B12-17-52.png\"\u003e\u003c/a\u003e\u003cbr\u003e\nเมื่อเข้าไปใน folder ก็จะพบ model_weight.h5 ที่เราสั่งเซฟไว้ใน Code ของเราหลัง Train เสร็จ  \u003c/p\u003e\n\u003cp\u003eเป็นอันเสร็จสิ้นการทดลองเล่น Google Cloud Machine Learning Engine ครับผม  \u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eเพิ่มเติม\u003c/strong\u003e  \u003c/p\u003e\n\u003cp\u003eทดลอง Download weight model มาลองรัน predict ดู  \u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://2.bp.blogspot.com/-KZphJ4YP2IQ/WY6TO9Z-WOI/AAAAAAAA0y8/acz9X9uXQT4aMuYRbZjDNV0LKMn5PGINACLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B12-33-12.png\"\u003e\u003cimg src=\"https://2.bp.blogspot.com/-KZphJ4YP2IQ/WY6TO9Z-WOI/AAAAAAAA0y8/acz9X9uXQT4aMuYRbZjDNV0LKMn5PGINACLcBGAs/s640/Screenshot%2Bat%2B2017-08-12%2B12-33-12.png\"\u003e\u003c/a\u003e\u003cbr\u003e\n\u003cstrong\u003eสามารถดู Code ทั้งหมดได้ที่\u003c/strong\u003e\u003cbr\u003e\n\u003ca href=\"https://github.com/kittinan/thai-handwriting-number\"\u003ehttps://github.com/kittinan/thai-handwriting-number\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://github.com/kittinan/thai-handwriting-number/tree/master/src/cloud-ml-engine\"\u003ehttps://github.com/kittinan/thai-handwriting-number/tree/master/src/cloud-ml-engine\u003c/a\u003e  \u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eอ้างอิง\u003c/strong\u003e\u003cbr\u003e\n\u003ca href=\"https://cloud.google.com/ml-engine\"\u003ehttps://cloud.google.com/ml-engine\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://github.com/clintonreece/keras-cloud-ml-engine\"\u003ehttps://github.com/clintonreece/keras-cloud-ml-engine\u003c/a\u003e\u003c/p\u003e\n","title":"Train Model บน Cloud ด้วย Google Cloud Machine Learning Engine","date":"2017-08-13 12:06:00"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"2017-08-13-train-model-on-google-ml-engine.html"},"buildId":"aI9pSBjpCZgVp7hfDsaNf","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>