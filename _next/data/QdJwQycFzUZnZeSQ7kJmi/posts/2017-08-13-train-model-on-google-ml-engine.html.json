{"pageProps":{"postData":{"id":"2017-08-13-train-model-on-google-ml-engine.html","contentHtml":"<p>สวัสดีครับผมจะมาเล่าประสบการณ์ การทดลองใช้งาน <a href=\"https://cloud.google.com/ml-engine/\"><strong>Google Cloud Machine Learning Engine</strong></a> หรือเรียกสั้นๆ Cloud ML Engine โดยความสามารถของมันก็คือ การนำ Model Machine Learning ที่เราสร้างขึ้นมาโดย <a href=\"https://www.tensorflow.org/\">Tensorflow</a> หรือ <a href=\"https://keras.io/\">Keras</a> (Tensorflow Backend) ไป Train บน Cloud ของ Google นั่นเอง ซึ่งการใช้งาน Cloud ML Engine นั้นมีค่าใช้จ่ายคร่าวๆดังนี้  </p>\n<p><a href=\"https://3.bp.blogspot.com/-ghbCz1e90j0/WYxMvtczNiI/AAAAAAAA0nE/TtV_h2HCgDMgmKxfPKb54Qsf8CwxIKr_wCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-10%2B19-08-14.png\"><img src=\"https://3.bp.blogspot.com/-ghbCz1e90j0/WYxMvtczNiI/AAAAAAAA0nE/TtV_h2HCgDMgmKxfPKb54Qsf8CwxIKr_wCLcBGAs/s640/Screenshot%2Bat%2B2017-08-10%2B19-08-14.png\"></a>  </p>\n<p> วิธีการคำนวนราคาโดยละเอียดจะคิดเป็น ML training unit ซึ่งสามารถตรวจสอบได้ที่ <a href=\"https://cloud.google.com/ml-engine/pricing\">https://cloud.google.com/ml-engine/pricing</a>  </p>\n<p>สำหรับ Account Google Cloud ใหม่ Google จะให้ Credit 300 USD ใช้ได้ 12 เดือน ดูรายละเอียดได้ที่ <a href=\"https://cloud.google.com/free/\">https://cloud.google.com/free/</a> (ผมก็ใช้ไอตัว Free Credit เนี่ยแหละมาลองเล่น)  </p>\n<p> <strong>สิ่งที่ต้องการ</strong>  </p>\n<ul>\n<li>Account Google Cloud ที่ผูกบัตรเครดิตเรียบร้อย  </li>\n<li>เครื่องที่ติดตั้ง  Google Cloud SDK เสร็จเรียบร้อย (วิธีการติดตั้งดูที่ <a href=\"https://cloud.google.com/sdk/downloads\">https://cloud.google.com/sdk/downloads</a>)  </li>\n<li>Code Model ที่ต้องการ Train (ในที่นี้ผมจะ Train โดยใช้ Keras ที่มี Tensorflow เป็น Backend โดยใช้โปรเจค <a href=\"https://github.com/kittinan/thai-handwriting-number\">thai-handwriting-number</a>)  </li>\n</ul>\n<p><strong>สร้างโปรเจค</strong>  </p>\n<ul>\n<li>ทำการสร้างโปรเจคใหม่หรือจะใช้โปรเจคเดิมที่มีอยู่แล้วก็ได้  </li>\n</ul>\n<p>| <a href=\"https://1.bp.blogspot.com/-FgpPaZZVufs/WYxm9AYL72I/AAAAAAAA0nc/EWnvYtDOmcwk0AQgPBMIFUeJDpOsYedBACLcBGAs/s1600/Screenshot%2Bat%2B2017-08-10%2B20-59-16.png\"><img src=\"https://1.bp.blogspot.com/-FgpPaZZVufs/WYxm9AYL72I/AAAAAAAA0nc/EWnvYtDOmcwk0AQgPBMIFUeJDpOsYedBACLcBGAs/s1600/Screenshot%2Bat%2B2017-08-10%2B20-59-16.png\"></a> |\n| สร้างโปรจคใหม่โดยใช้ชื่อ test-cloud-ml |</p>\n<ul>\n<li>รันคำสั่งในเครื่องเราเอง  </li>\n</ul>\n<blockquote>\n<p>gcloud projects list</p>\n</blockquote>\n<p>ก็จะขึ้นโปรเจคใหม่ที่เราสร้างขึ้นมาดังภาพ  </p>\n<p><a href=\"https://4.bp.blogspot.com/-odVVsQQqgn4/WYxo-Oit6wI/AAAAAAAA0no/GrMYC3X9auEZ-gxHO9wB5zy7ZhTEd53PACLcBGAs/s1600/Screenshot%2Bat%2B2017-08-10%2B21-06-31.png\"><img src=\"https://4.bp.blogspot.com/-odVVsQQqgn4/WYxo-Oit6wI/AAAAAAAA0no/GrMYC3X9auEZ-gxHO9wB5zy7ZhTEd53PACLcBGAs/s640/Screenshot%2Bat%2B2017-08-10%2B21-06-31.png\"></a>  </p>\n<p>ตั้งให้โปรเจค test-cloud-ml เป็นโปรเจคหลัก (ใช้ PROJECT_ID)  </p>\n<blockquote>\n<p>gcloud config set project test-cloud-ml-176413</p>\n</blockquote>\n<p>เปิดการใช้งาน Google Cloud Machine Learning Engine ให้กับโปรเจคของเรา โดยเข้าไปที่ APIs &#x26; services > Library  </p>\n<p>| <a href=\"https://2.bp.blogspot.com/-gdxbkOybfYs/WY5v1MwrSmI/AAAAAAAA0xU/McytEFTAXxQ76r_AHXVYoIeRzXgJ6UTJwCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-11%2B16-57-10.png\"><img src=\"https://2.bp.blogspot.com/-gdxbkOybfYs/WY5v1MwrSmI/AAAAAAAA0xU/McytEFTAXxQ76r_AHXVYoIeRzXgJ6UTJwCLcBGAs/s640/Screenshot%2Bat%2B2017-08-11%2B16-57-10.png\"></a> |\n| เลือก Machine Learning Engine API |</p>\n<p>| <a href=\"https://1.bp.blogspot.com/-fsOLbygwdHM/WY5v2L3o3II/AAAAAAAA0xY/5mFMAyEo6hc_ax36NXEdtpE5_R0DJ9THACLcBGAs/s1600/Screenshot%2Bat%2B2017-08-11%2B16-57-33.png\"><img src=\"https://1.bp.blogspot.com/-fsOLbygwdHM/WY5v2L3o3II/AAAAAAAA0xY/5mFMAyEo6hc_ax36NXEdtpE5_R0DJ9THACLcBGAs/s640/Screenshot%2Bat%2B2017-08-11%2B16-57-33.png\"></a> |\n| กด Enable |</p>\n<p> <strong>สิ่งที่ควรรู้ก่อนการปรับปรุง Code เพื่อนำไป Train บน Cloud</strong>  </p>\n<ul>\n<li> Cloud ML Runtime นั้นใช้ <strong>Python 2.7</strong> สามารถตรวจสอบ Package ต่างๆและ Version ของ Cloud ML Runtime ได้ที่ <a href=\"https://cloud.google.com/ml-engine/docs/concepts/runtime-version-list\">https://cloud.google.com/ml-engine/docs/concepts/runtime-version-list</a>  </li>\n<li>ข้อมูลที่เรา Read / Write ทั้งหมดนั้นต้องผ่าน <a href=\"https://cloud.google.com/storage/\">Google Cloud Storage</a>  (เราควรจัดการ Dataset ที่จะใช้ Train ให้สะดวกในการใช้งาน ในที่นี้จะจัดการ Dataset ให้อยู่ใน format ของ pickle ซึ่งต้องใช้ protocol version 2)  </li>\n</ul>\n<p><strong>ปรับปรุง Code สำหรับ Train บน Cloud</strong>  </p>\n<ol>\n<li>จัดการอัพโหลด Dataset ที่ใช้ในการ Train อัพโหลดขึ้น Google Cloud Stroage เสียก่อน ในที่นี้ผม Serialize ข้อมูลด้วย pickle แล้วเซฟเป็นไฟล์ไว้ โดยต้องใช้ protolcol version 2  </li>\n</ol>\n<blockquote>\n<p>pickle.dump(DATASET_VARIABLE, open(\"dataset.pkl\", \"wb\"), protocol = 2)</p>\n</blockquote>\n<p>1.1 จัดการสร้าง bucket ของ Google Cloud Storage โดยในที่นี้จะตั้งชื่อ bucket ว่า kittinan (bucket เปรียบเสมือนตู้คอนเทนเนอร์อันนึงที่เอาไว้จัดเก็บข้อมูลของเรา <a href=\"https://cloud.google.com/storage/docs/key-terms#buckets\">https://cloud.google.com/storage/docs/key-terms#buckets</a>)  โดยสร้าง bucket ด้วยคำสั่ง  </p>\n<blockquote>\n<p> gsutil mb gs://kittinan/</p>\n</blockquote>\n<p>หรือเราสามารถสร้างในหน้าเวปก็ได้  </p>\n<p><a href=\"https://2.bp.blogspot.com/-UgXUlEF0-FU/WY2DVxwzdtI/AAAAAAAA0ro/N5KBPoE72PQt90zCocIWoTCQ3S2f6q-SwCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-11%2B17-13-26.png\"><img src=\"https://2.bp.blogspot.com/-UgXUlEF0-FU/WY2DVxwzdtI/AAAAAAAA0ro/N5KBPoE72PQt90zCocIWoTCQ3S2f6q-SwCLcBGAs/s640/Screenshot%2Bat%2B2017-08-11%2B17-13-26.png\"></a>  </p>\n<p>1.2 อัพโหลดไฟล์ Dataset เข้า Google Cloud Storage ด้วยคำสั่ง  </p>\n<blockquote>\n<p>gsutil cp SOURCE gs:://BUCKET_NAME/</p>\n</blockquote>\n<p>ตัวอย่าง  </p>\n<blockquote>\n<p>gsutil cp src/thainumber_28.pkl gs://kittinan/</p>\n</blockquote>\n<p>| <a href=\"https://2.bp.blogspot.com/-7Tu4rpeiFGY/WY2FDucWZTI/AAAAAAAA0r4/cEvtg0UinS4o2wPlVRatLZdQ-8IGzxUgACLcBGAs/s1600/Screenshot%2Bat%2B2017-08-11%2B17-20-22.png\"><img src=\"https://2.bp.blogspot.com/-7Tu4rpeiFGY/WY2FDucWZTI/AAAAAAAA0r4/cEvtg0UinS4o2wPlVRatLZdQ-8IGzxUgACLcBGAs/s640/Screenshot%2Bat%2B2017-08-11%2B17-20-22.png\"></a> |\n| ภาพเมื่ออัพโหลดไฟล์เสร็จ |</p>\n<p>| <a href=\"https://3.bp.blogspot.com/-gmzoMc1GyN0/WY2FDulFAhI/AAAAAAAA0r0/3KPI8lUutvQmtOA46_DwUgXGOnQgnYGMwCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-11%2B17-20-50.png\"><img src=\"https://3.bp.blogspot.com/-gmzoMc1GyN0/WY2FDulFAhI/AAAAAAAA0r0/3KPI8lUutvQmtOA46_DwUgXGOnQgnYGMwCLcBGAs/s640/Screenshot%2Bat%2B2017-08-11%2B17-20-50.png\"></a> |\n| ลองเข้าไปดูในหน้าเวป Google Cloud Storage ก็จะเจอไฟล์ที่เราเพิ่งอัพโหลดเพิ่มขึ้นมา |</p>\n<ol start=\"2\">\n<li>สร้าง Folder ชื่ออะไรก็ได้ (ในที่นี้จะใช้ชื่อ Folder ว่า cloud-ml-engine) โดยมีโครงสร้างไฟล์ดังนี้  </li>\n</ol>\n<p><a href=\"https://3.bp.blogspot.com/-LPBb2YGLf-I/WY5-3yyqX5I/AAAAAAAA0x8/XgXFY8ZFvawtwiHagNzIckEjgnktBY50QCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B11-06-32.png\"><img src=\"https://3.bp.blogspot.com/-LPBb2YGLf-I/WY5-3yyqX5I/AAAAAAAA0x8/XgXFY8ZFvawtwiHagNzIckEjgnktBY50QCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B11-06-32.png\"></a>  </p>\n<p><strong>setup.py</strong><br>\nระบุข้อมูลต่างๆ และ require package ต่างๆ<br>\n<a href=\"https://cloud.google.com/ml-engine/docs/how-tos/packaging-trainer#recommended_project_structure\">https://cloud.google.com/ml-engine/docs/how-tos/packaging-trainer#recommended_project_structure</a>  </p>\n<p><strong>config.yml</strong><br>\nระบุค่า parameter ต่างๆของการ Train ครั้งนี้ ในที่นี้ระบุว่าให้ใช้ scaleTiear ที่เป็น BASIC_GPU<br>\n<a href=\"https://cloud.google.com/ml-engine/reference/rest/v1/projects.jobs#traininginput\">https://cloud.google.com/ml-engine/reference/rest/v1/projects.jobs#traininginput</a>  </p>\n<p> <strong>trainer > __init__.py</strong><br>\nไฟล์เปล่าๆ ใช้สำหรับ setuptools ที่อยู่ในไฟล์ setup.py   </p>\n<p><strong>trainer > model.py</strong>  </p>\n<ul>\n<li>ใช้ argparse module ในการ parse argument ต่างๆ โดยใน code นี้จะทำการ parse argument ของ training data และ job directory (Google Cloud Storage Path)  </li>\n<li>Read / Write File ต่างๆ ด้วย tensorflow.python.lib.io.file_io แทน  </li>\n</ul>\n<p><strong>ทดสอบรันบนเครื่องตัวเองก่อนด้วยคำสั่ง</strong>  </p>\n<blockquote>\n<p>gcloud ml-engine local train \\<br>\n--job-dir ./ \\<br>\n--module-name trainer.model \\<br>\n--package-path ./trainer \\<br>\n-- \\<br>\n--train-file ../thainumber_28.pkl</p>\n</blockquote>\n<p>--job-dir : directory หรือ Google Cloud Storage ที่ใช้ในการ Package ไฟล์ (ML Engine จะส่ง argument job-dir ไปยัง script โปรแกรมเราด้วย)<br>\n--module-name : module ที่เราต้องการรัน<br>\n--package-path : path ของ module ที่เราจะรัน<br>\noption ที่อยู่หลัง -- \\ : คือ argument สำหรับ script โปรแกรมเรา  </p>\n<p>| <a href=\"https://2.bp.blogspot.com/-hZOegOna7tY/WY6I58YA4rI/AAAAAAAA0yM/krZFp04WJMECu8iyQX2o-v93ciabKQ_pgCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B11-49-31.png\"><img src=\"https://2.bp.blogspot.com/-hZOegOna7tY/WY6I58YA4rI/AAAAAAAA0yM/krZFp04WJMECu8iyQX2o-v93ciabKQ_pgCLcBGAs/s640/Screenshot%2Bat%2B2017-08-12%2B11-49-31.png\"></a> |\n| ภาพการรันบนเครื่องตัวเอง |</p>\n<p><strong>รันบน Cloud ML Engine</strong><br>\nผมสร้าง Shell Script ขึ้นมาชื่อไฟล์ start_train.sh เพื่อความสะดวกในการแก้ไขค่าต่างๆและการรัน โดยมีคำสั่งดังนี้  </p>\n<p>export environment variables ต่างๆดังนี้<br>\nBUCKET_NAME - ชื่อ Bucket Google Cloud Storage ที่เราใช้<br>\nJOB_NAME - ชื่อ job ของเรา<br>\nJOB_DIR - Path Bucket Google Cloud Storage<br>\nREGION - จะใช้ region ไหนในการรัน (ในที่นี้ใช้ US เพราะถูกกว่า)  </p>\n<p>Option ต่างๆของ command gcloud ก็จะคล้ายๆกับการรันแบบ Local โดยที่มีเพิ่มเติมขึ้นมาดังนี้  </p>\n<p>--runtime-version : จะใช้ runtime version ไหน (<a href=\"https://cloud.google.com/ml-engine/docs/concepts/runtime-version-list\">https://cloud.google.com/ml-engine/docs/concepts/runtime-version-list</a>)<br>\n--region : จะใช้ region ไหน<br>\n--config : config yaml ไฟล์ ที่ระบุ training input ต่างๆ<br>\n--train-file : Argument ของ script ที่ระบุ Path Training Data ที่อยู่บน  Google Cloud Storage  </p>\n<p>ลองรัน ./start_train.sh กันเลย  </p>\n<p><a href=\"https://1.bp.blogspot.com/-8gFd_NQ1V-E/WY6ONROzTQI/AAAAAAAA0yc/g0WJqCSOFzsBoUCZe3EatIFZzte-tGo9gCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B12-02-24.png\"><img src=\"https://1.bp.blogspot.com/-8gFd_NQ1V-E/WY6ONROzTQI/AAAAAAAA0yc/g0WJqCSOFzsBoUCZe3EatIFZzte-tGo9gCLcBGAs/s640/Screenshot%2Bat%2B2017-08-12%2B12-02-24.png\"></a>  </p>\n<p>เมื่อเรารันสำเร็จ gcloud command จะแนะนำคำสั่งในการ stream log ให้เรา เมื่อลองรันดูก็จะเห็น log ในการรันบน cloud ต่างๆดังภาพ  </p>\n<p><a href=\"https://1.bp.blogspot.com/-yBpj9m2XGWs/WY6Ojco-ezI/AAAAAAAA0yg/PvgbCyjCyQMZ0pB5w7LZGkyMP-g5m5MNQCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B12-02-42.png\"><img src=\"https://1.bp.blogspot.com/-yBpj9m2XGWs/WY6Ojco-ezI/AAAAAAAA0yg/PvgbCyjCyQMZ0pB5w7LZGkyMP-g5m5MNQCLcBGAs/s640/Screenshot%2Bat%2B2017-08-12%2B12-02-42.png\"></a><br>\nเราสามารถเข้าไปดู Log ในเวปได้ด้วยนะ<br>\n<a href=\"https://console.cloud.google.com/mlengine/jobs\">https://console.cloud.google.com/mlengine/jobs</a>  </p>\n<p><a href=\"https://4.bp.blogspot.com/-rOul_7niNUY/WY6PJYyQiHI/AAAAAAAA0ys/ljfdi0GcZ0MTnbQnEVHfrotyfvRCi8LyACLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B12-15-19.png\"><img src=\"https://4.bp.blogspot.com/-rOul_7niNUY/WY6PJYyQiHI/AAAAAAAA0ys/ljfdi0GcZ0MTnbQnEVHfrotyfvRCi8LyACLcBGAs/s400/Screenshot%2Bat%2B2017-08-12%2B12-15-19.png\"></a>  </p>\n<p><a href=\"https://2.bp.blogspot.com/-SDXafD-P9kE/WY6PJeaq95I/AAAAAAAA0yo/2WeEmJsBkp4uXpTSxB6bHB7zIYcMUUF3gCLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B12-15-58.png\"><img src=\"https://2.bp.blogspot.com/-SDXafD-P9kE/WY6PJeaq95I/AAAAAAAA0yo/2WeEmJsBkp4uXpTSxB6bHB7zIYcMUUF3gCLcBGAs/s400/Screenshot%2Bat%2B2017-08-12%2B12-15-58.png\"></a><br>\nหลังจากรันเสร็จลองเข้าไปดูใน  Bucket ของเราก็จะพบกับ folder ที่มีชื่อ job name ของเรา  </p>\n<p><a href=\"https://1.bp.blogspot.com/-L6akpOsvIH8/WY6PkkVaxvI/AAAAAAAA0yw/Ur6HRg3fPWQVvgF2BucUivsDAUnduZw3ACLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B12-17-52.png\"><img src=\"https://1.bp.blogspot.com/-L6akpOsvIH8/WY6PkkVaxvI/AAAAAAAA0yw/Ur6HRg3fPWQVvgF2BucUivsDAUnduZw3ACLcBGAs/s640/Screenshot%2Bat%2B2017-08-12%2B12-17-52.png\"></a><br>\nเมื่อเข้าไปใน folder ก็จะพบ model_weight.h5 ที่เราสั่งเซฟไว้ใน Code ของเราหลัง Train เสร็จ  </p>\n<p>เป็นอันเสร็จสิ้นการทดลองเล่น Google Cloud Machine Learning Engine ครับผม  </p>\n<p><strong>เพิ่มเติม</strong>  </p>\n<p>ทดลอง Download weight model มาลองรัน predict ดู  </p>\n<p><a href=\"https://2.bp.blogspot.com/-KZphJ4YP2IQ/WY6TO9Z-WOI/AAAAAAAA0y8/acz9X9uXQT4aMuYRbZjDNV0LKMn5PGINACLcBGAs/s1600/Screenshot%2Bat%2B2017-08-12%2B12-33-12.png\"><img src=\"https://2.bp.blogspot.com/-KZphJ4YP2IQ/WY6TO9Z-WOI/AAAAAAAA0y8/acz9X9uXQT4aMuYRbZjDNV0LKMn5PGINACLcBGAs/s640/Screenshot%2Bat%2B2017-08-12%2B12-33-12.png\"></a><br>\n<strong>สามารถดู Code ทั้งหมดได้ที่</strong><br>\n<a href=\"https://github.com/kittinan/thai-handwriting-number\">https://github.com/kittinan/thai-handwriting-number</a><br>\n<a href=\"https://github.com/kittinan/thai-handwriting-number/tree/master/src/cloud-ml-engine\">https://github.com/kittinan/thai-handwriting-number/tree/master/src/cloud-ml-engine</a>  </p>\n<p><strong>อ้างอิง</strong><br>\n<a href=\"https://cloud.google.com/ml-engine\">https://cloud.google.com/ml-engine</a><br>\n<a href=\"https://github.com/clintonreece/keras-cloud-ml-engine\">https://github.com/clintonreece/keras-cloud-ml-engine</a></p>\n","title":"Train Model บน Cloud ด้วย Google Cloud Machine Learning Engine","date":"2017-08-13 12:06:00"}},"__N_SSG":true}